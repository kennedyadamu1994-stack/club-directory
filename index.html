<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discover Local Clubs | NBRH</title>

<!-- Performance hints -->
<link rel="preconnect" href="https://sheets.googleapis.com">
<link rel="dns-prefetch" href="https://sheets.googleapis.com">

<style>
  :root{
    --brand:#FF006E;
    --bg:#1B1B1B;
    --card-bg:#2a2a2a;
    --text:#ffffff;
    --text-secondary:#999;
    --border:#444;
    --radius:3px;
    --shadow:0 1px 3px rgba(0,0,0,0.3);
    --shadow-hover:0 4px 12px rgba(0,0,0,0.5);
    --verified-blue:#1DA1F2;
  }

  *{ margin:0; padding:0; box-sizing:border-box; }

  body{
    font-family:'ITC Avant Garde Gothic Pro', -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
    line-height:1.6;
  }

  /* ---------- NBRH Brand Header ---------- */
  .nbrh-header{
    background:#1c1c1e;
    color:#fff;
    position:sticky; top:0; z-index:1000;
    box-shadow:0 2px 10px rgba(0,0,0,0.1);
  }
  .nbrh-header-inner{
    max-width:1400px; margin:0 auto; padding:12px 20px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .nbrh-logo-link{ display:block; line-height:0; }
  .nbrh-logo{ height:36px; object-fit:contain; transition:opacity .2s; }
  .nbrh-logo:hover{ opacity:.8; }
  .nbrh-nav{ display:flex; gap:16px; align-items:center; }
  .nbrh-nav a{ color:#fff; text-decoration:none; font-weight:500; }
  .nbrh-nav a:hover{ color:var(--brand); }

  /* ---------- Page Header ---------- */
  .club-header{
    text-align:center;
    padding:50px 20px;
    margin:0 auto 30px;
    background:var(--card-bg);
    border-bottom:1px solid var(--border);
  }
  .club-header h1{
    font-size:36px; font-weight:600; margin-bottom:12px; letter-spacing:-0.5px;
    color:var(--text);
  }
  .club-header p{
    font-size:18px; opacity:0.8; max-width:700px; margin:0 auto;
    color:var(--text);
  }

  /* ---------- Loading / error ---------- */
  .club-loading,.club-error{
    max-width:1200px;
    margin:2rem auto;
    padding:0 1.5rem;
    text-align:center;
  }
  .club-loading{ color:var(--text-secondary); }
  .club-spinner{
    display:inline-block; width:40px; height:40px;
    border:3px solid #333; border-top-color:var(--brand);
    border-radius:50%; animation:spin 1s linear infinite; margin-bottom:1rem;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .club-error{
    background:var(--card-bg);
    border:1px solid #ff3b30;
    border-radius:var(--radius);
    color:#ff3b30;
    padding:20px;
    box-shadow:var(--shadow);
  }

  /* ---------- Search Section ---------- */
  .search-section{
    max-width:1400px; margin:0 auto 20px; padding:0 20px;
  }
  .search-container{ position:relative; max-width:700px; margin:0 auto; }
  .search-input{
    width:100%; padding:16px 20px 16px 50px;
    border:1px solid var(--border); border-radius:var(--radius);
    font-size:16px; background:var(--card-bg); box-shadow:var(--shadow);
    transition:all 0.3s ease; font-family:inherit;
    color:var(--text);
  }
  .search-input::placeholder{ color:var(--text-secondary); }
  .search-input:focus{ outline:none; border-color:var(--brand); box-shadow:0 4px 12px rgba(255,0,110,0.15); }
  .search-icon{ position:absolute; left:18px; top:50%; transform:translateY(-50%); color:var(--text-secondary); font-size:16px; }

  /* ---------- Toolbar ---------- */
  .club-toolbar{
    max-width:1400px; margin:0 auto 30px; padding:0 20px;
    display:flex; gap:12px; flex-wrap:wrap; align-items:center;
  }
  .club-btn{
    padding:12px 20px; border:1px solid var(--border); border-radius:var(--radius);
    background:var(--card-bg); color:var(--text); font-weight:500; cursor:pointer;
    font-size:14px; transition:all 0.2s ease; font-family:inherit; box-shadow:var(--shadow);
  }
  .club-btn:hover{ background:#3a3a3a; box-shadow:var(--shadow-hover); }
  .club-btn.primary{ background:var(--brand); border-color:var(--brand); color:#fff; }
  .club-btn.primary:hover{ background:#e60062; border-color:#e60062; }
  .club-btn:disabled{ opacity:0.5; cursor:not-allowed; }

  #result-count{ margin-left:auto; font-size:14px; color:var(--text-secondary); font-weight:500; }

  /* ---------- Cards grid ---------- */
  .club-grid{
    max-width:1400px; margin:0 auto 60px; padding:0 20px;
    display:grid; gap:24px; grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
    align-items:start;
  }

  /* ---------- Card styling ---------- */
  .club-card{
    display:flex; flex-direction:column; background:var(--card-bg);
    border-radius:var(--radius); box-shadow:var(--shadow);
    overflow:hidden; transition:all 0.3s ease; height:fit-content;
  }
  .club-card:hover{ transform:translateY(-4px); box-shadow:var(--shadow-hover); }

  /* ---------- Image container ---------- */
  .club-img-container{ position:relative; width:100%; height:200px; overflow:hidden; }
  .club-card.featured .club-img-container{ border-bottom:3px solid #FFD700; }
  .club-card.featured .club-img-container::after{
    content:"FEATURED"; position:absolute; top:12px; left:12px;
    background:#FFD700; color:#1c1c1e; padding:6px 12px; border-radius:3px;
    font-size:12px; font-weight:600; z-index:4; box-shadow:0 2px 8px rgba(0,0,0,0.2);
  }
  .club-img{ width:100%; height:100%; object-fit:cover; transition:transform 0.3s ease; }
  .club-card:hover .club-img{ transform:scale(1.05); }

  /* ---------- Overlay: rating only ---------- */
  .club-rating-overlay{
    position:absolute; top:12px; left:12px; font-weight:600; padding:6px 10px;
    border-radius:3px; color:#fff; font-size:14px; min-width:32px; text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,0.2); z-index:3; backdrop-filter:blur(10px);
  }
  .club-card.featured .club-rating-overlay{ top:60px; }

  /* Rating colours (based on 0‚Äì10) */
  .club-score-0{background:rgba(139,0,0,0.9)}
  .club-score-1{background:rgba(165,42,42,0.9)}
  .club-score-2{background:rgba(205,92,92,0.9)}
  .club-score-3{background:rgba(220,20,60,0.9)}
  .club-score-4{background:rgba(255,69,0,0.9)}
  .club-score-5{background:rgba(255,165,0,0.9)}
  .club-score-6{background:rgba(218,165,32,0.9)}
  .club-score-7{background:rgba(34,139,34,0.9)}
  .club-score-8{background:rgba(50,205,50,0.9)}
  .club-score-9{background:rgba(34,139,34,0.9)}
  .club-score-10{background:rgba(0,100,0,0.9)}

  /* ---------- Verification badge (top-right) ---------- */
  .club-verified-badge{
    position:absolute; top:12px; right:12px;
    background:#FF006E; color:#fff; padding:6px 10px;
    border-radius:3px; font-size:12px; font-weight:600; z-index:4;
    box-shadow:0 2px 8px rgba(0,0,0,0.2); backdrop-filter:blur(10px);
    display:flex; align-items:center; gap:4px;
  }
  .club-verified-badge svg{
    width:14px; height:14px; fill:currentColor;
  }

  /* ---------- Card content ---------- */
  .club-content{ padding:20px; display:flex; flex-direction:column; gap:10px; flex-grow:1; }
  .club-title-row{ display:flex; align-items:center; gap:6px; margin-bottom:4px; }
  .club-title{ font-size:18px; font-weight:600; color:var(--text); line-height:1.3; margin:0; }
  .club-title-verified{
    display:inline-flex; align-items:center; justify-content:center;
    width:18px; height:18px; background:#FF006E; border-radius:50%;
    flex-shrink:0;
  }
  .club-title-verified svg{
    width:12px; height:12px; fill:#fff;
  }
  .club-activity{ font-size:16px; color:var(--brand); font-weight:500; margin:0; }
  .club-location{ font-size:14px; color:var(--text-secondary); display:flex; align-items:center; gap:4px; }

  /* ---------- Price and info row ---------- */
  .club-price-rating-row{
    display:flex; justify-content:space-between; align-items:center; gap:16px; margin-top:6px;
  }
  .club-price{ font-size:18px; font-weight:600; color:var(--brand); }
  .club-price.free{ color:#30a330; }

  /* Audience chip */
  .club-audience{
    font-size:12px; font-weight:500; color:#1c1c1e;
    background:#f2f2f7; border-radius:3px; padding:4px 8px;
  }

  /* ---------- Stats row ---------- */
  .club-stats-row{
    display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin:12px 0 4px;
  }
  .club-stat{
    text-align:center; padding:12px 8px; background:#333; border-radius:3px;
  }
  .club-stat-number{ font-size:16px; font-weight:600; color:var(--brand); display:block; margin-bottom:2px; }
  .club-stat-label{ font-size:12px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.5px; font-weight:500; }

  /* ---------- Badges ---------- */
  .club-badges-container{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-top:8px; margin-bottom:auto; }
  .club-badge{ display:inline-block; background:var(--brand); color:#fff; border-radius:3px; padding:4px 8px; font-size:12px; font-weight:500; }
  .club-badge.beginners{ background:#30a330 }
  .club-badge.wheelchair{ background:#007aff }
  .club-badge.all-ages{ background:#FF6B35 }

  /* ---------- Actions ---------- */
  .club-card-actions{ display:flex; margin-top:auto; padding:0 20px 20px; }
  .club-btn.details{
    flex:1; text-align:center; text-decoration:none;
    padding:14px 16px; font-weight:600; font-size:14px;
    background:var(--brand); border:1px solid var(--brand); color:#fff; border-radius:var(--radius);
    transition:all 0.2s ease;
  }
  .club-btn.details:hover{ background:#e60062; border-color:#e60062; }

  /* ---------- Modal ---------- */
  .club-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.7); z-index:99999; backdrop-filter:blur(4px); padding:20px; }
  .club-modal.active{ display:flex; }
  .club-dialog{
    background:var(--card-bg); border-radius:var(--radius); width:100%; max-width:420px; padding:24px; max-height:85vh; overflow-y:auto; box-shadow:0 20px 50px rgba(0,0,0,0.5);
  }
  .club-dialog h2{ margin:0 0 20px; font-size:20px; font-weight:600; color:var(--text); }
  .club-field{ margin-bottom:16px; display:flex; flex-direction:column; }
  .club-label{ font-weight:500; margin-bottom:6px; color:var(--text); font-size:14px; }
  .club-dialog select, .club-dialog input[type="number"]{
    padding:12px 16px; border:1px solid var(--border); border-radius:var(--radius); font-size:16px; background:#333; color:var(--text); font-family:inherit;
  }
  .club-dialog select:focus, .club-dialog input:focus{ outline:none; border-color:var(--brand); }
  .club-check{ display:flex; align-items:center; gap:8px; font-size:14px; margin-bottom:8px; color:var(--text); }
  .club-actions{ display:flex; gap:12px; margin-top:24px; }
  .club-actions .club-btn{ flex:1; }

  /* ---------- Advanced toggle ---------- */
  .club-advanced-toggle{
    width:100%; padding:12px 16px; margin:16px 0; background:#333; border:1px solid var(--border); border-radius:var(--radius);
    cursor:pointer; font-size:14px; font-weight:500; color:var(--text); display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s ease;
  }
  .club-advanced-toggle:hover{ background:#3a3a3a; }
  .club-advanced-toggle:after{ content:'‚ñº'; font-size:12px; transition:transform 0.3s ease; }
  .club-advanced-toggle.active:after{ transform:rotate(180deg); }

  .club-advanced-section{ display:none; padding-top:16px; border-top:1px solid var(--border); margin-top:16px; }
  .club-advanced-section.active{ display:block; }

  /* ---------- Mobile ---------- */
  @media (max-width: 480px){
    .club-grid{ grid-template-columns:1fr; padding:0 16px; gap:20px; }
    .club-header{ padding:40px 20px; margin-bottom:24px; }
    .club-header h1{ font-size:28px; }
    .club-header p{ font-size:16px; }
    .search-section{ padding:0 16px; margin-bottom:16px; }
    .search-input{ padding:14px 18px 14px 45px; font-size:16px; }
    .club-toolbar{ padding:0 16px; margin-bottom:20px; flex-direction:column; gap:8px; }
    .club-toolbar .club-btn{ width:100%; justify-content:center; }
    .club-img-container{ height:180px; }
    .club-content{ padding:16px; }
    .club-title{ font-size:16px; }
    .club-card-actions{ padding:0 16px 16px; }
    .club-btn.details{ font-size:14px; padding:12px 14px; }
    .club-dialog{ margin:16px; padding:20px; }
  }
  @media (min-width: 481px) and (max-width: 768px){
    .club-grid{ grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; }
  }
</style>
</head>

<body>
<!-- NBRH Brand Header -->
<header class="nbrh-header">
  <div class="nbrh-header-inner">
    <a href="https://www.thenbrh.co.uk/" class="nbrh-logo-link">
      <img class="nbrh-logo" alt="NBRH" src="https://images.squarespace-cdn.com/content/6718416feaa24175e29324d4/9d6e6464-e1e5-4dde-9ae0-03df420cbd77/NBRH+Logo.png?content-type=image%2Fpng">
    </a>
    <nav class="nbrh-nav">
      <a href="/">Browse Clubs</a>
    </nav>
  </div>
</header>

<!-- Page Header -->
<div class="club-header">
  <h1>Discover Local Clubs</h1>
  <p>Find the perfect community for your interests and activity level</p>
</div>

<!-- Search Section -->
<div class="search-section">
  <div class="search-container">
    <div class="search-icon">üîç</div>
    <input type="text" class="search-input" id="searchInput" placeholder="Search clubs by name, activity, or location‚Ä¶">
  </div>
</div>

<div id="loading-state" class="club-loading">
  <div class="club-spinner"></div><p>Loading clubs‚Ä¶</p>
</div>
<div id="error-state" class="club-error" style="display:none;">
  <p>Failed to load clubs. Check your connection or try again.</p>
  <button class="club-btn primary" onclick="window.location.reload()">Try Again</button>
</div>

<div id="main-content" style="display:none;">
  <div class="club-toolbar">
    <button class="club-btn primary" id="open-filter">Filter Clubs</button>
    <button class="club-btn" id="open-sort">Sort</button>
    <button class="club-btn" id="reload">Refresh Data</button>
    <p id="result-count"></p>
  </div>
  <div id="cards" class="club-grid" aria-live="polite"></div>
</div>

<!-- ---------- Filter Modal ---------- -->
<div id="filter-modal" class="club-modal" aria-modal="true" role="dialog">
  <div class="club-dialog">
    <h2>Filter Clubs</h2>
    <div class="club-main-filters">
      <div class="club-field"><label class="club-label" for="f-activity">Activity Type</label><select id="f-activity"><option value="">Any activity</option></select></div>
      <div class="club-field"><label class="club-label" for="f-location">Location</label><select id="f-location"><option value="">Any location</option></select></div>
      <div class="club-field"><label class="club-label">Monthly fee ¬£</label>
        <div style="display:flex;gap:8px">
          <input type="number" id="f-pmin" placeholder="Min" min="0" value="0" style="width:100%">
          <input type="number" id="f-pmax" placeholder="Max" min="0" style="width:100%">
        </div>
      </div>
      <div class="club-check"><input type="checkbox" id="f-beginners"><label for="f-beginners">Beginner friendly</label></div>
      <div class="club-check"><input type="checkbox" id="f-verified"><label for="f-verified">Verified clubs only</label></div>
      <div class="club-check"><input type="checkbox" id="f-featured"><label for="f-featured">Featured clubs only</label></div>
    </div>

    <button class="club-advanced-toggle" id="toggle-advanced">Advanced filters</button>

    <div class="club-advanced-section" id="advanced-section">
      <div class="club-field"><label class="club-label" for="f-ages">Age Groups</label>
        <select id="f-ages"><option value="">Any age group</option></select>
      </div>
      <div class="club-field"><label class="club-label" for="f-skills">Skill Levels</label>
        <select id="f-skills"><option value="">Any skill level</option></select>
      </div>
      <div class="club-field"><label class="club-label" for="f-members">Minimum members</label>
        <select id="f-members"><option value="">Any size</option><option value="50">50+ members</option><option value="100">100+ members</option><option value="200">200+ members</option></select>
      </div>
      <div class="club-check"><input type="checkbox" id="f-wheelchair"><label for="f-wheelchair">Wheelchair accessible</label></div>
      <div class="club-check"><input type="checkbox" id="f-all-ages"><label for="f-all-ages">All ages welcome</label></div>
    </div>

    <div class="club-actions">
      <button class="club-btn" id="f-reset">Reset all</button>
      <button class="club-btn primary" id="f-apply">Apply filters</button>
    </div>
  </div>
</div>

<!-- ---------- Sort Modal ---------- -->
<div id="sort-modal" class="club-modal" aria-modal="true" role="dialog">
  <div class="club-dialog">
    <h2>Sort clubs by</h2>
    <div class="club-field">
      <select id="s-key">
        <option value="default">Default (Featured ‚Üí Rating ‚Üí Members)</option>
        <option value="ranking">Ranking position (best ‚Üí worst)</option>
        <option value="rating">NBRH rating (high ‚Üí low)</option>
        <option value="members">Member count (high ‚Üí low)</option>
        <option value="priceLow">Price (low ‚Üí high)</option>
        <option value="priceHigh">Price (high ‚Üí low)</option>
        <option value="name">Name (A ‚Üí Z)</option>
        <option value="location">Location (A ‚Üí Z)</option>
      </select>
    </div>
    <div class="club-actions">
      <button class="club-btn" id="s-close">Cancel</button>
      <button class="club-btn primary" id="s-apply">Apply</button>
    </div>
  </div>
</div>

<script>
(function(){
  const els = {
    loading: document.getElementById('loading-state'),
    error: document.getElementById('error-state'),
    main: document.getElementById('main-content'),
    cards: document.getElementById('cards'),
    result: document.getElementById('result-count'),
    search: document.getElementById('searchInput'),
    filterOpen: document.getElementById('open-filter'),
    sortOpen: document.getElementById('open-sort'),
    reload: document.getElementById('reload'),
    filterModal: document.getElementById('filter-modal'),
    sortModal: document.getElementById('sort-modal'),
    advToggle: document.getElementById('toggle-advanced'),
    advSection: document.getElementById('advanced-section'),
    fActivity: document.getElementById('f-activity'),
    fLocation: document.getElementById('f-location'),
    fMin: document.getElementById('f-pmin'),
    fMax: document.getElementById('f-pmax'),
    fBeginners: document.getElementById('f-beginners'),
    fVerified: document.getElementById('f-verified'),
    fFeatured: document.getElementById('f-featured'),
    fAges: document.getElementById('f-ages'),
    fSkills: document.getElementById('f-skills'),
    fMembers: document.getElementById('f-members'),
    fWheel: document.getElementById('f-wheelchair'),
    fAllAges: document.getElementById('f-all-ages'),
    fReset: document.getElementById('f-reset'),
    fApply: document.getElementById('f-apply'),
    sKey: document.getElementById('s-key'),
    sClose: document.getElementById('s-close'),
    sApply: document.getElementById('s-apply'),
  };

  let RAW = [];
  let VIEW = [];
  let SORT = 'default';

  // Checkmark SVG for verified badge
  const checkmarkSVG = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';

  function classForScore(score){
    const n = Math.max(0, Math.min(10, Math.round(Number(score)||0)));
    return 'club-score-' + n;
  }

  function money(n){
    const v = Number(n);
    if (!isFinite(v) || v<=0) return '';
    return '¬£' + (Math.round(v*100)/100).toFixed(v%1?2:0);
  }

  // Extract numeric price for sorting from either monthly_fee_amount or monthly_fee_text
  function getPriceForSort(club) {
    // First try monthly_fee_amount
    const amount = Number(club.monthly_fee_amount);
    if (isFinite(amount) && amount > 0) {
      return amount;
    }
    
    // If no amount, try to extract from monthly_fee_text
    const text = String(club.monthly_fee_text || '').toLowerCase();
    
    // Handle "free" explicitly
    if (text.includes('free') || text.includes('varies')) {
      return 0;
    }
    
    // Extract first number from text (e.g., "¬£10 Per Session" -> 10, "¬£35 + Fees" -> 35)
    const match = text.match(/¬£?(\d+(?:\.\d+)?)/);
    if (match) {
      return Number(match[1]);
    }
    
    // Default to 0 if we can't determine
    return 0;
  }

  function closeAllModals(){
    els.filterModal.classList.remove('active');
    els.sortModal.classList.remove('active');
  }

  function open(el){ el.classList.add('active'); }
  function close(el){ el.classList.remove('active'); }

  function uniqueSorted(arr){
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  }

  function renderFiltersOptions(list){
    const acts = uniqueSorted(list.map(x=>x.activity_type));
    const locs = uniqueSorted(list.map(x=>x.location));
    const ages = uniqueSorted(list.map(x=>x.age_groups || x.tags_who));
    const skills = uniqueSorted(list.map(x=>x.skill_levels));

    els.fActivity.innerHTML = '<option value="">Any activity</option>' + acts.map(a=>`<option>${a}</option>`).join('');
    els.fLocation.innerHTML = '<option value="">Any location</option>' + locs.map(a=>`<option>${a}</option>`).join('');
    els.fAges.innerHTML = '<option value="">Any age group</option>' + ages.map(a=>`<option>${a}</option>`).join('');
    els.fSkills.innerHTML = '<option value="">Any skill level</option>' + skills.map(a=>`<option>${a}</option>`).join('');
  }

  function applyFilters(){
    const q = els.search.value.trim().toLowerCase();
    const minP = Number(els.fMin.value||0);
    const maxP = Number(els.fMax.value||0) || Infinity;

    VIEW = RAW.filter(c=>{
      if (q){
        const blob = [c.club_name,c.activity_type,c.location,c.audience].join(' ').toLowerCase();
        if (!blob.includes(q)) return false;
      }
      if (els.fActivity.value && c.activity_type !== els.fActivity.value) return false;
      if (els.fLocation.value && c.location !== els.fLocation.value) return false;
      if (els.fVerified.checked && !c.verified) return false;
      if (els.fFeatured.checked && !c.featured) return false;

      const price = Number(c.monthly_fee_amount||0);
      if (price && price < minP) return false;
      if (isFinite(maxP) && price > maxP) return false;

      if (els.fBeginners.checked && !(String(c.tags_who||'').toLowerCase().includes('beginner'))) return false;
      if (els.fAges.value && !(String(c.age_groups||'').includes(els.fAges.value))) return false;
      if (els.fSkills.value && c.skill_levels && c.skill_levels !== 'All levels' && c.skill_levels !== els.fSkills.value) return false;
      if (els.fMembers.value && Number(c.member_count||0) < Number(els.fMembers.value)) return false;
      if (els.fWheel.checked && !c.is_wheelchair_accessible) return false;
      if (els.fAllAges.checked && !c.is_all_ages) return false;

      return true;
    });

    applySortAndRender();
  }

  function applySortAndRender(){
    const key = SORT;
    
    // Create a COPY to avoid mutating during render
    const sorted = [...VIEW];
    
    console.log('=== SORT DEBUG ===');
    console.log('Sort key:', key);
    console.log('Items to sort:', sorted.length);
    
    // Sample first 5 items before sort
    if (key.includes('price')) {
      console.log('Sample prices BEFORE sort:');
      sorted.slice(0, 5).forEach(c => {
        console.log(`  ${c.club_name}: amount=${c.monthly_fee_amount}, text="${c.monthly_fee_text}", extracted=${getPriceForSort(c)}`);
      });
    }
    
    sorted.sort((a,b)=>{
      // Helper to safely get numbers
      const getNum = (val) => {
        const n = Number(val);
        return isFinite(n) ? n : 0;
      };
      
      switch(key){
        case 'rating': 
          return getNum(b.numeric_rating) - getNum(a.numeric_rating);
          
        case 'members': 
          return getNum(b.member_count) - getNum(a.member_count);
          
        case 'priceLow': 
          // Use smart price extraction
          const aPrice = getPriceForSort(a);
          const bPrice = getPriceForSort(b);
          const result = aPrice - bPrice;
          return result;
          
        case 'priceHigh': 
          // Use smart price extraction
          const aPriceHigh = getPriceForSort(a);
          const bPriceHigh = getPriceForSort(b);
          const resultHigh = bPriceHigh - aPriceHigh;
          return resultHigh;
          
        case 'name': 
          const aName = String(a.club_name || '');
          const bName = String(b.club_name || '');
          return aName.localeCompare(bName);
          
        case 'location': 
          const aLoc = String(a.location || '');
          const bLoc = String(b.location || '');
          return aLoc.localeCompare(bLoc);
          
        default:
          // Default: Featured ‚Üí Rating ‚Üí Members
          const featuredDiff = (b.featured?1:0) - (a.featured?1:0);
          if (featuredDiff !== 0) return featuredDiff;
          
          const ratingDiff = getNum(b.numeric_rating) - getNum(a.numeric_rating);
          if (ratingDiff !== 0) return ratingDiff;
          
          return getNum(b.member_count) - getNum(a.member_count);
      }
    });

    // Sample first 10 items after sort
    if (key.includes('price')) {
      console.log('Sample prices AFTER sort:');
      sorted.slice(0, 10).forEach(c => {
        console.log(`  ${c.club_name}: ¬£${getPriceForSort(c)} (from "${c.monthly_fee_text}")`);
      });
    }

    renderCards(sorted);
  }

  function cardHtml(c){
    const price = c.monthly_fee_amount ? `${money(c.monthly_fee_amount)}/mo` : (c.monthly_fee_text||'');
    const rating = Number(c.numeric_rating||0);
    const overlayClass = 'club-rating-overlay ' + classForScore(rating);
    const img = c.image_url || 'https://images.unsplash.com/photo-1552667466-07770ae110d0?auto=format&fit=crop&w=1200&q=80';
    const code = c.club_code || '';

    const badges = [];
    if (String(c.tags_who||'').toLowerCase().includes('beginner')) badges.push('<span class="club-badge beginners">Beginner friendly</span>');
    if (c.is_wheelchair_accessible) badges.push('<span class="club-badge wheelchair">Accessible</span>');
    if (c.is_all_ages) badges.push('<span class="club-badge all-ages">All ages</span>');

    // Verification badge in image overlay
    const verifiedOverlay = c.verified ? `<div class="club-verified-badge">${checkmarkSVG}Verified</div>` : '';

    return `
      <article class="club-card ${c.featured?'featured':''}">
        <div class="club-img-container">
          <img class="club-img" alt="${c.club_name || 'Club photo'}" src="${img}">
          <div class="${overlayClass}">${isFinite(rating)?rating.toFixed(1):0}</div>
          ${verifiedOverlay}
        </div>
        <div class="club-content">
          <div class="club-title-row">
            <h3 class="club-title">${c.club_name || 'Unknown Club'}</h3>
            ${c.verified ? `<span class="club-title-verified">${checkmarkSVG}</span>` : ''}
          </div>
          <p class="club-activity">${c.activity_type || ''}</p>
          <p class="club-location">üìç ${c.location || ''}</p>

          <div class="club-price-rating-row">
            <div class="club-price ${(!price || /free/i.test(price)) ? 'free' : ''}">${price || 'Free / varies'}</div>
            ${c.audience ? `<span class="club-audience">${c.audience}</span>` : ``}
          </div>

          <div class="club-stats-row">
            <div class="club-stat"><span class="club-stat-number">${c.sessions_per_week||0}</span><span class="club-stat-label">Sessions/Wk</span></div>
            <div class="club-stat"><span class="club-stat-number">${c.member_count||0}</span><span class="club-stat-label">Members</span></div>
            <div class="club-stat"><span class="club-stat-number">${c.ranking_position?('#'+c.ranking_position):'-'}</span><span class="club-stat-label">Rank</span></div>
          </div>

          <div class="club-badges-container">
            ${badges.join('')}
          </div>
        </div>

        <div class="club-card-actions">
          <a class="club-btn details" href="/club/${code}" aria-label="View details for ${c.club_name}">View details</a>
        </div>
      </article>
    `;
  }

  function renderCards(list){
    els.cards.innerHTML = list.map(cardHtml).join('');
    els.result.textContent = `${list.length} result${list.length===1?'':'s'}`;
  }

  async function loadClubData(force=false){
    try{
      els.loading.style.display = '';
      els.error.style.display = 'none';
      els.main.style.display = 'none';

      const url = `/api/clubs?t=${Date.now()}`;
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) throw new Error('Failed to load');
      const data = await res.json();

      RAW = Array.isArray(data) ? data : [];
      renderFiltersOptions(RAW);
      els.search.value = '';
      
      // Reset all filters
      els.fActivity.value = '';
      els.fLocation.value = '';
      els.fMin.value = '0';
      els.fMax.value = '';
      els.fBeginners.checked = false;
      els.fVerified.checked = false;
      els.fFeatured.checked = false;
      els.fAges.value = '';
      els.fSkills.value = '';
      els.fMembers.value = '';
      els.fWheel.checked = false;
      els.fAllAges.checked = false;
      
      // Reset sort to default
      SORT = 'default';
      els.sKey.value = 'default';
      
      applyFilters();

      els.loading.style.display = 'none';
      els.main.style.display = '';
    }catch(err){
      console.error(err);
      els.loading.style.display = 'none';
      els.error.style.display = '';
    }
  }

  // Events
  els.search.addEventListener('input', ()=>applyFilters());

  els.filterOpen.addEventListener('click', ()=>open(els.filterModal));
  els.sortOpen.addEventListener('click', ()=>open(els.sortModal));
  els.reload.addEventListener('click', ()=>loadClubData(true));

  els.advToggle.addEventListener('click', ()=>{
    els.advToggle.classList.toggle('active');
    els.advSection.classList.toggle('active');
  });

  els.fReset.addEventListener('click', ()=>{
    els.fActivity.value = '';
    els.fLocation.value = '';
    els.fMin.value = '0';
    els.fMax.value = '';
    els.fBeginners.checked = false;
    els.fVerified.checked = false;
    els.fFeatured.checked = false;
    els.fAges.value = '';
    els.fSkills.value = '';
    els.fMembers.value = '';
    els.fWheel.checked = false;
    els.fAllAges.checked = false;
    applyFilters();
  });
  
  els.fApply.addEventListener('click', ()=>{ 
    close(els.filterModal); 
    applyFilters(); 
  });

  els.sClose.addEventListener('click', ()=>close(els.sortModal));
  els.sApply.addEventListener('click', ()=>{
    SORT = els.sKey.value || 'default';
    close(els.sortModal);
    applySortAndRender();
  });

  // Close modals on backdrop click
  [els.filterModal, els.sortModal].forEach(m=>{
    m.addEventListener('click', (e)=>{ if (e.target === m) close(m); });
  });

  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') closeAllModals();
  });

  // Init
  loadClubData();
})();
</script>
</body>
</html>
