<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discover Local Clubs</title>

<!-- Performance hints -->
<link rel="preconnect" href="https://sheets.googleapis.com">
<link rel="dns-prefetch" href="https://sheets.googleapis.com">

<style>
  :root{
    --brand:#FF006E;
    --bg:#f5f5f7;
    --card-bg:#ffffff;
    --text:#1c1c1e;
    --text-secondary:#8e8e93;
    --border:#d1d1d6;
    --radius:12px;
    --shadow:0 1px 3px rgba(0,0,0,0.1);
    --shadow-hover:0 4px 12px rgba(0,0,0,0.15);
  }
  
  *{
    margin:0;
    padding:0;
    box-sizing:border-box;
  }
  
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
    line-height:1.6;
  }

  /* ---------- Loading / error ---------- */
  .club-loading,.club-error{
    max-width:1200px;
    margin:2rem auto;
    padding:0 1.5rem;
    text-align:center;
  }
  .club-loading{
    color:var(--text-secondary);
  }
  .club-spinner{
    display:inline-block;
    width:40px;
    height:40px;
    border:3px solid var(--border);
    border-top-color:var(--brand);
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin-bottom:1rem;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .club-error{
    background:var(--card-bg);
    border:1px solid #ffcccc;
    border-radius:var(--radius);
    color:#ff3b30;
    padding:20px;
    box-shadow:var(--shadow);
  }

  /* ---------- Header ---------- */
  .club-header{
    background:#1c1c1e;
    color:white;
    text-align:center;
    padding:50px 20px;
    margin-bottom:30px;
  }
  
  .club-header h1{
    font-size:36px;
    font-weight:600;
    margin-bottom:12px;
    letter-spacing:-0.5px;
  }
  
  .club-header p{
    font-size:18px;
    opacity:0.8;
    max-width:600px;
    margin:0 auto;
    font-weight:400;
  }

  /* ---------- Search Section ---------- */
  .search-section{
    max-width:1400px;
    margin:0 auto 30px;
    padding:0 20px;
  }
  
  .search-container{
    position:relative;
    max-width:600px;
    margin:0 auto;
  }
  
  .search-input{
    width:100%;
    padding:16px 20px 16px 50px;
    border:1px solid var(--border);
    border-radius:var(--radius);
    font-size:16px;
    background:var(--card-bg);
    box-shadow:var(--shadow);
    transition:all 0.3s ease;
    font-family:inherit;
  }
  
  .search-input:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 4px 12px rgba(255,0,110,0.15);
  }
  
  .search-icon{
    position:absolute;
    left:18px;
    top:50%;
    transform:translateY(-50%);
    color:var(--text-secondary);
    font-size:16px;
  }

  /* ---------- Toolbar ---------- */
  .club-toolbar{
    max-width:1400px;
    margin:0 auto 30px;
    padding:0 20px;
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
  }
  
  .club-btn{
    padding:12px 20px;
    border:1px solid var(--border);
    border-radius:var(--radius);
    background:var(--card-bg);
    color:var(--text);
    font-weight:500;
    cursor:pointer;
    font-size:14px;
    transition:all 0.2s ease;
    font-family:inherit;
    box-shadow:var(--shadow);
  }
  
  .club-btn:hover{
    background:#f8f9fa;
    box-shadow:var(--shadow-hover);
  }
  
  .club-btn.primary{
    background:var(--brand);
    border-color:var(--brand);
    color:white;
  }
  
  .club-btn.primary:hover{
    background:#e60062;
    border-color:#e60062;
  }
  
  .club-btn:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }

  /* ---------- Cards grid ---------- */
  .club-grid{
    max-width:1400px;
    margin:0 auto 60px;
    padding:0 20px;
    display:grid;
    gap:24px;
    grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
    align-items:start;
  }
  
  /* ---------- Card styling ---------- */
  .club-card{
    display:flex;
    flex-direction:column;
    background:var(--card-bg);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    transition:all 0.3s ease;
    height:fit-content;
  }
  
  .club-card:hover{
    transform:translateY(-4px);
    box-shadow:var(--shadow-hover);
  }
  
  /* ---------- Image container ---------- */
  .club-img-container{
    position:relative;
    width:100%;
    height:200px;
    overflow:hidden;
  }
  
  .club-card.featured .club-img-container{
    border-bottom:3px solid #FFD700;
  }
  
  .club-card.featured .club-img-container::after{
    content:"FEATURED";
    position:absolute;
    top:12px;
    left:12px;
    background:#FFD700;
    color:#1c1c1e;
    padding:6px 12px;
    border-radius:6px;
    font-size:12px;
    font-weight:600;
    z-index:4;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
  }
  
  .club-img{
    width:100%;
    height:100%;
    object-fit:cover;
    transition:transform 0.3s ease;
  }
  
  .club-card:hover .club-img{
    transform:scale(1.05);
  }
  
  /* ---------- Overlay elements ---------- */
  .club-website-icon{
    position:absolute;
    top:12px;
    right:12px;
    width:32px;
    height:32px;
    background:rgba(255,255,255,0.9);
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    color:var(--brand);
    text-decoration:none;
    box-shadow:0 2px 8px rgba(0,0,0,0.15);
    transition:all 0.2s ease;
    z-index:3;
    backdrop-filter:blur(10px);
  }
  
  .club-website-icon:hover{
    background:white;
    transform:scale(1.1);
  }
  
  .club-rating-overlay{
    position:absolute;
    top:12px;
    left:12px;
    font-weight:600;
    padding:6px 10px;
    border-radius:6px;
    color:white;
    font-size:14px;
    min-width:32px;
    text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
    z-index:3;
    backdrop-filter:blur(10px);
  }
  
  .club-card.featured .club-rating-overlay{top:60px}
  
  /* Rating colors */
  .club-rating-overlay.club-score-0{background:rgba(139,0,0,0.9)}
  .club-rating-overlay.club-score-1{background:rgba(165,42,42,0.9)}
  .club-rating-overlay.club-score-2{background:rgba(205,92,92,0.9)}
  .club-rating-overlay.club-score-3{background:rgba(220,20,60,0.9)}
  .club-rating-overlay.club-score-4{background:rgba(255,69,0,0.9)}
  .club-rating-overlay.club-score-5{background:rgba(255,165,0,0.9)}
  .club-rating-overlay.club-score-6{background:rgba(218,165,32,0.9)}
  .club-rating-overlay.club-score-7{background:rgba(34,139,34,0.9)}
  .club-rating-overlay.club-score-8{background:rgba(50,205,50,0.9)}
  .club-rating-overlay.club-score-9{background:rgba(34,139,34,0.9)}
  .club-rating-overlay.club-score-10{background:rgba(0,100,0,0.9)}
  
  /* ---------- Card content ---------- */
  .club-content{
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:12px;
    flex-grow:1;
  }
  
  .club-title{
    font-size:18px;
    font-weight:600;
    color:var(--text);
    line-height:1.3;
    margin:0;
  }
  
  .club-activity{
    font-size:16px;
    color:var(--brand);
    font-weight:500;
    margin:0;
  }
  
  .club-location{
    font-size:14px;
    color:var(--text-secondary);
    margin:0;
    display:flex;
    align-items:center;
    gap:4px;
  }
  
  /* ---------- Price and rating row ---------- */
  .club-price-rating-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:16px;
    margin-top:8px;
  }
  
  .club-price{
    font-size:18px;
    font-weight:600;
    color:var(--brand);
  }
  
  .club-price.free{
    color:#30a330;
  }
  
  .club-rating-section{
    display:flex;
    align-items:center;
    gap:4px;
    font-size:14px;
    color:var(--text-secondary);
  }
  
  /* ---------- Stats row ---------- */
  .club-stats-row{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:12px;
    margin:16px 0;
  }
  
  .club-stat{
    text-align:center;
    padding:12px 8px;
    background:#f8f9fa;
    border-radius:8px;
  }
  
  .club-stat-number{
    font-size:16px;
    font-weight:600;
    color:var(--brand);
    display:block;
    margin-bottom:2px;
  }
  
  .club-stat-label{
    font-size:12px;
    color:var(--text-secondary);
    text-transform:uppercase;
    letter-spacing:0.5px;
    font-weight:500;
  }

  /* ---------- Badges ---------- */
  .club-badges-container{
    display:flex;
    align-items:center;
    gap:6px;
    flex-wrap:wrap;
    margin-top:12px;
    margin-bottom:auto;
  }
  
  .club-badge{
    display:inline-block;
    background:var(--brand);
    color:white;
    border-radius:6px;
    padding:4px 8px;
    font-size:12px;
    font-weight:500;
  }
  
  .club-badge.beginners{background:#30a330}
  .club-badge.advanced{background:#8B5CF6}
  .club-badge.all-ages{background:#FF6B35}
  .club-badge.wheelchair{background:#007aff}
  
  /* ---------- Action buttons ---------- */
  .club-card-actions{
    display:flex;
    gap:12px;
    margin-top:auto;
    padding:0 20px 20px;
  }
  
  .club-card-actions .club-btn{
    flex:1;
    padding:12px 16px;
    font-weight:500;
    font-size:14px;
    text-align:center;
    border-radius:var(--radius);
    transition:all 0.2s ease;
    text-decoration:none;
    display:block;
    border:1px solid var(--border);
  }
  
  .club-btn.details{
    background:var(--card-bg);
    color:var(--text);
  }
  
  .club-btn.details:hover{
    background:#f8f9fa;
  }
  
  .club-btn.join{
    background:var(--brand);
    border-color:var(--brand);
    color:white;
  }
  
  .club-btn.join:hover{
    background:#e60062;
    border-color:#e60062;
  }
  
  /* ---------- Stars ---------- */
  .club-rating-stars{
    display:inline-flex;
    gap:1px;
    margin-left:4px;
  }
  
  .club-rating-stars .star{
    color:#d1d1d6;
    font-size:12px;
  }
  
  .club-rating-stars .star.filled{
    color:#FFD700;
  }
  
  .club-rating-stars .star.partial{
    background:linear-gradient(90deg, #FFD700 var(--fill-percent, 0%), #d1d1d6 var(--fill-percent, 0%));
    background-clip:text;
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }

  /* ---------- Modal styling ---------- */
  .club-modal{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.4);
    z-index:99999;
    backdrop-filter:blur(4px);
    padding:20px;
  }
  
  .club-modal.active{
    display:flex;
  }
  
  .club-dialog{
    background:var(--card-bg);
    border-radius:var(--radius);
    width:100%;
    max-width:400px;
    padding:24px;
    max-height:85vh;
    overflow-y:auto;
    box-shadow:0 20px 50px rgba(0,0,0,0.15);
  }
  
  .club-dialog h2{
    margin:0 0 20px;
    font-size:20px;
    font-weight:600;
    color:var(--text);
  }
  
  .club-field{
    margin-bottom:16px;
    display:flex;
    flex-direction:column;
  }
  
  .club-label{
    font-weight:500;
    margin-bottom:6px;
    color:var(--text);
    font-size:14px;
  }
  
  .club-dialog select,
  .club-dialog input[type="number"]{
    padding:12px 16px;
    border:1px solid var(--border);
    border-radius:8px;
    font-size:16px;
    background:var(--card-bg);
    color:var(--text);
    font-family:inherit;
  }
  
  .club-dialog select:focus,
  .club-dialog input:focus{
    outline:none;
    border-color:var(--brand);
  }
  
  .club-check{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:14px;
    margin-bottom:8px;
  }
  
  .club-actions{
    display:flex;
    gap:12px;
    margin-top:24px;
  }
  
  .club-actions .club-btn{
    flex:1;
  }
  
  /* ---------- Advanced toggle ---------- */
  .club-advanced-toggle{
    width:100%;
    padding:12px 16px;
    margin:16px 0;
    background:#f8f9fa;
    border:1px solid var(--border);
    border-radius:8px;
    cursor:pointer;
    font-size:14px;
    font-weight:500;
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    transition:all 0.2s ease;
  }
  
  .club-advanced-toggle:hover{
    background:#f0f0f0;
  }
  
  .club-advanced-toggle:after{
    content:'▼';
    font-size:12px;
    transition:transform 0.3s ease;
  }
  
  .club-advanced-toggle.active:after{
    transform:rotate(180deg);
  }
  
  .club-advanced-section{
    display:none;
    padding-top:16px;
    border-top:1px solid var(--border);
    margin-top:16px;
  }
  
  .club-advanced-section.active{
    display:block;
  }

  /* ---------- Stars in filter ---------- */
  .club-stars{
    display:flex;
    gap:4px;
    font-size:20px;
    cursor:pointer;
  }
  
  .club-stars span{
    color:var(--border);
    transition:color 0.2s;
  }
  
  .club-stars span:hover{
    color:#ffb3d1;
  }
  
  .club-stars span.active{
    color:var(--brand);
  }

  /* ---------- Result count ---------- */
  #result-count{
    margin-left:auto;
    font-size:14px;
    color:var(--text-secondary);
    font-weight:500;
  }

  /* ---------- Mobile responsive ---------- */
  @media (max-width: 480px){
    .club-grid{
      grid-template-columns:1fr;
      padding:0 16px;
      gap:20px;
    }
    
    .club-header{
      padding:40px 20px;
      margin-bottom:24px;
    }
    
    .club-header h1{
      font-size:28px;
    }
    
    .club-header p{
      font-size:16px;
    }
    
    .search-section{
      padding:0 16px;
      margin-bottom:24px;
    }
    
    .search-input{
      padding:14px 18px 14px 45px;
      font-size:16px;
    }
    
    .club-toolbar{
      padding:0 16px;
      margin-bottom:24px;
      flex-direction:column;
      gap:8px;
    }
    
    .club-toolbar .club-btn{
      width:100%;
      justify-content:center;
    }
    
    .club-img-container{
      height:180px;
    }
    
    .club-content{
      padding:16px;
    }
    
    .club-title{
      font-size:16px;
    }
    
    .club-card-actions{
      padding:0 16px 16px;
    }
    
    .club-card-actions .club-btn{
      font-size:14px;
      padding:10px 14px;
    }
    
    .club-dialog{
      margin:16px;
      padding:20px;
    }
  }
  
  @media (min-width: 481px) and (max-width: 768px){
    .club-grid{
      grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
      gap:20px;
    }
  }
</style>
</head>

<body>
<!-- Header -->
<div class="club-header">
  <h1>Discover Local Clubs</h1>
  <p>Find the perfect community for your interests and activity level</p>
</div>

<!-- Search Section -->
<div class="search-section">
  <div class="search-container">
    <div class="search-icon">🔍</div>
    <input type="text" class="search-input" id="searchInput" placeholder="Search clubs by name, activity, or location...">
  </div>
</div>

<div id="loading-state" class="club-loading">
  <div class="club-spinner"></div><p>Loading clubs…</p>
</div>
<div id="error-state" class="club-error" style="display:none;">
  <p>Failed to load clubs. Check your connection or try again.</p>
  <button class="club-btn primary" onclick="loadClubData(true)">Try Again</button>
</div>

<div id="main-content" style="display:none;">
  <div class="club-toolbar">
    <button class="club-btn primary" id="open-filter">Filter Clubs</button>
    <button class="club-btn" id="open-sort">Sort</button>
    <button class="club-btn" onclick="window.tempCacheKey && localStorage.removeItem(window.tempCacheKey); loadClubData(true);" title="Clear cache and reload">Refresh Data</button>
    <p id="result-count"></p>
  </div>
  <div id="cards" class="club-grid" aria-live="polite"></div>
</div>

<!-- ---------- Filter Modal ---------- -->
<div id="filter-modal" class="club-modal" aria-modal="true" role="dialog">
  <div class="club-dialog">
    <h2>Filter Clubs</h2>
    <div class="club-main-filters">
      <div class="club-field"><label class="club-label" for="f-activity">Activity Type</label><select id="f-activity"><option value="">Any activity</option></select></div>
      <div class="club-field"><label class="club-label" for="f-location">Location</label><select id="f-location"><option value="">Any location</option></select></div>
      <div class="club-field"><label class="club-label">Monthly fee £</label>
        <div style="display:flex;gap:8px">
          <input type="number" id="f-pmin" placeholder="Min" min="0" value="0" style="width:100%">
          <input type="number" id="f-pmax" placeholder="Max" min="0" style="width:100%">
        </div>
      </div>
      <div class="club-check"><input type="checkbox" id="f-beginners"><label for="f-beginners">Beginner friendly</label></div>
      <div class="club-check"><input type="checkbox" id="f-featured"><label for="f-featured">Featured clubs only</label></div>
    </div>

    <button class="club-advanced-toggle" id="toggle-advanced">Advanced filters</button>

    <div class="club-advanced-section" id="advanced-section">
      <div class="club-field"><label class="club-label" for="f-ages">Age Groups</label>
        <select id="f-ages"><option value="">Any age group</option></select>
      </div>
      <div class="club-field"><label class="club-label" for="f-skills">Skill Levels</label>
        <select id="f-skills"><option value="">Any skill level</option></select>
      </div>
      <div class="club-field"><label class="club-label">NBRH Rating</label>
        <div id="f-stars" class="club-stars" data-value="0"></div>
        <small style="color:var(--text-secondary);font-size:12px">Minimum rating (0–5)</small>
      </div>
      <div class="club-field"><label class="club-label" for="f-members">Minimum members</label>
        <select id="f-members"><option value="">Any size</option><option value="50">50+ members</option><option value="100">100+ members</option><option value="200">200+ members</option></select>
      </div>
      <div class="club-check"><input type="checkbox" id="f-wheelchair"><label for="f-wheelchair">Wheelchair accessible</label></div>
      <div class="club-check"><input type="checkbox" id="f-all-ages"><label for="f-all-ages">All ages welcome</label></div>
    </div>

    <div class="club-actions">
      <button class="club-btn" id="f-reset">Reset all</button>
      <button class="club-btn primary" id="f-apply">Apply filters</button>
    </div>
  </div>
</div>

<!-- ---------- Sort Modal ---------- -->
<div id="sort-modal" class="club-modal" aria-modal="true" role="dialog">
  <div class="club-dialog">
    <h2>Sort clubs by</h2>
    <div class="club-field">
      <select id="s-key">
        <option value="default">Default (Featured → Rating → Members)</option>
        <option value="rating">NBRH rating (high → low)</option>
        <option value="members">Member count (high → low)</option>
        <option value="priceLow">Price (low → high)</option>
        <option value="priceHigh">Price (high → low)</option>
        <option value="name">Name (A → Z)</option>
        <option value="location">Location (A → Z)</option>
      </select>
    </div>
    <div class="club-actions">
      <button class="club-btn" id="s-close">Cancel</button>
      <button class="club-btn primary" id="s-apply">Apply</button>
    </div>
  </div>
</div>

<script>
/* ========= DYNAMIC CLUB DISCOVERY SYSTEM ========= */

/* ========= 1) CONFIG ========= */
// Use backend API instead of direct Google Sheets API
const API_BASE_URL = '/api'; // Your Vercel API endpoints
const CACHE_KEY = 'clubs:backend:v1';
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 min

/* ========= 2) GLOBALS ========= */
let clubs = [];
let filteredClubs = [];
let isDataLoaded = false;
let sortKey = 'default';
let _initDone = false;
let _fetchController = null;

window.tempCacheKey = CACHE_KEY;

/* ========= 3) DATA LOAD with backend API ========= */
async function fetchClubRows(forceFresh = false) {
  const now = Date.now();
  if (!forceFresh) {
    try {
      const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
      if (cached && now - cached.t < CACHE_TTL_MS) return cached.data;
    } catch {}
  }
  
  if (_fetchController) _fetchController.abort();
  _fetchController = new AbortController();
  
  // Use backend API to get all clubs
  const res = await fetch(`${API_BASE_URL}/clubs`, { 
    cache: 'no-store', 
    signal: _fetchController.signal 
  });
  
  if (!res.ok) {
    throw new Error(`Failed to load clubs: ${res.status} ${res.statusText}`);
  }
  
  const data = await res.json();
  
  try { 
    localStorage.setItem(CACHE_KEY, JSON.stringify({ t: now, data })); 
  } catch {}
  
  return data;
}

async function loadClubData(forceFresh = false) {
  const loadingState = document.getElementById('loading-state');
  const errorState   = document.getElementById('error-state');
  const mainContent  = document.getElementById('main-content');

  loadingState.style.display = 'block';
  errorState.style.display   = 'none';
  mainContent.style.display  = 'none';

  try {
    const clubsData = await fetchClubRows(forceFresh);
    console.log('Fetched club data:', clubsData);
    
    if (!clubsData || !Array.isArray(clubsData)) {
      throw new Error('Invalid data format received');
    }
    
    clubs = clubsData.map((club, i) => ({
      id: i + 1,
      club_id: String(club.club_id || ''),
      club_code: String(club.club_code || club.club_name?.toLowerCase().replace(/[^a-z0-9]+/g, '-')),
      club_name: String(club.club_name || 'Unnamed Club'),
      activity_type: String(club.activity_type || ''),
      location: String(club.location || ''),
      address: String(club.address || ''),
      monthly_fee: parseFloat(club.monthly_fee_amount || club.monthly_fee) || 0,
      description: String(club.club_bio || club.description || ''),
      image_url: String(club.image_url || `https://source.unsplash.com/featured/?${club.activity_type||'fitness'}`),
      website: String(club.website || ''),
      phone: String(club.phone || ''),
      email: String(club.email || ''),
      rating: parseFloat(club.numeric_rating || club.rating) || 0,
      user_rating: parseFloat(club.numeric_rating || club.user_rating) || 0,
      review_count: parseFloat(club.review_count) || (club.testimonials ? club.testimonials.length : 0),
      total_members: parseFloat(club.member_count || club.total_members) || 0,
      sessions_per_week: parseFloat(club.sessions_per_week) || 0,
      age_groups: String(club.tags_who || club.age_groups || ''),
      skill_levels: String(club.skill_levels || 'All levels'),
      tags: String(club.tags || ''),
      facilities: String(club.facilities_list || club.facilities || ''),
      instructor_name: String(club.coach_name || club.instructor_name || ''),
      instructor_bio: String(club.coach_role || club.instructor_bio || ''),
      active: String(club.active || '').toLowerCase() === 'yes',
      featured: club.featured === true || String(club.featured || '').toLowerCase() === 'yes' || club.ranking_category === 'Featured',
      booking_url: String(club.booking_url || ''),
      page_url: String(club.page_url || `/club/${club.club_code || club.club_name?.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`),
      admin_url: String(club.admin_url || ''),
      
      // Computed properties with better data mapping
      is_beginner_friendly: String(club.tags_who || club.tags || '').toLowerCase().includes('beginner'),
      is_wheelchair_accessible: (String(club.tags_accessibility || club.facilities || '').toLowerCase().includes('wheelchair') || 
                                String(club.tags_accessibility || club.facilities || '').toLowerCase().includes('accessible')),
      is_all_ages: String(club.tags_who || club.age_groups || '').toLowerCase().includes('all ages')
    })).filter(club => club.active); // Only show active clubs

    if (!clubs.length) throw new Error('No active clubs found');

    loadingState.style.display = 'none';
    mainContent.style.display  = 'block';
    isDataLoaded = true;

    initializeApp();
  } catch (err) {
    if (err.name === 'AbortError') return;
    console.error('Error loading clubs:', err);
    loadingState.style.display = 'none';
    errorState.style.display   = 'block';
    
    // Update error message with more details
    const errorElement = errorState.querySelector('p');
    errorElement.textContent = `Failed to load clubs: ${err.message}. Please check your backend API configuration.`;
  }
}

/* ========= 4) INIT ========= */
function initializeApp() {
  if (_initDone) { render(); return; }
  _initDone = true;

  // Populate filter dropdowns
  const activities = [...new Set(clubs.map(c => c.activity_type))].filter(Boolean).sort();
  const actSelect  = document.getElementById('f-activity');
  actSelect.innerHTML = '<option value="">Any activity</option>';
  activities.forEach(a => { const o=document.createElement('option'); o.value=o.textContent=a; actSelect.appendChild(o); });

  const locations = [...new Set(clubs.map(c => c.location))].filter(Boolean).sort();
  const locSelect = document.getElementById('f-location');
  locSelect.innerHTML = '<option value="">Any location</option>';
  locations.forEach(l => { const o=document.createElement('option'); o.value=o.textContent=l; locSelect.appendChild(o); });

  const ageGroups = [...new Set(clubs.map(c => c.age_groups))].filter(Boolean).sort();
  const ageSelect = document.getElementById('f-ages');
  ageSelect.innerHTML = '<option value="">Any age group</option>';
  ageGroups.forEach(a => { const o=document.createElement('option'); o.value=o.textContent=a; ageSelect.appendChild(o); });

  const skillLevels = [...new Set(clubs.map(c => c.skill_levels))].filter(Boolean).sort();
  const skillSelect = document.getElementById('f-skills');
  skillSelect.innerHTML = '<option value="">Any skill level</option>';
  skillLevels.forEach(s => { const o=document.createElement('option'); o.value=o.textContent=s; skillSelect.appendChild(o); });

  buildStarUI();
  setupEventListeners();
  render();
}

const qs = id => document.getElementById(id);

function buildStarUI() {
  const wrap = qs('f-stars');
  wrap.innerHTML = '';
  for (let i=1;i<=5;i++){const s=document.createElement('span');s.textContent='★';s.dataset.val=i;wrap.appendChild(s);}
  updateStarUI(0);
  wrap.addEventListener('click',e=>{if(e.target.dataset.val){wrap.dataset.value=e.target.dataset.val;updateStarUI(e.target.dataset.val);}});
}
const updateStarUI = v => [...qs('f-stars').children].forEach((el,i)=>el.classList.toggle('active',i<v));

function setupEventListeners() {
  const openFilter=qs('open-filter'), openSort=qs('open-sort');
  const filterModal=qs('filter-modal'), sortModal=qs('sort-modal');
  const toggleAdv=qs('toggle-advanced'), advSection=qs('advanced-section');
  const closeModal=m=>{m.classList.remove('active');document.body.style.overflow='';};

  toggleAdv.onclick=()=>{toggleAdv.classList.toggle('active');advSection.classList.toggle('active');
    toggleAdv.textContent=toggleAdv.classList.contains('active')?'Hide advanced filters':'Advanced filters';};

  openFilter.onclick=()=>{filterModal.classList.add('active');document.body.style.overflow='hidden';};
  openSort  .onclick=()=>{sortModal .classList.add('active');document.body.style.overflow='hidden';};

  filterModal.addEventListener('click',e=>{if(e.target===filterModal)closeModal(filterModal);});
  sortModal  .addEventListener('click',e=>{if(e.target===sortModal )closeModal(sortModal );});
  qs('s-close').onclick=()=>closeModal(sortModal);

  qs('f-apply').onclick=()=>{closeModal(filterModal);render();};

  qs('f-reset').onclick=()=>{filterModal.querySelectorAll('select').forEach(s=>s.value='');
    filterModal.querySelectorAll('input[type="number"]').forEach(i=>i.value='');
    filterModal.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
    updateStarUI(0);qs('f-stars').dataset.value='0';toggleAdv.classList.remove('active');advSection.classList.remove('active');
    toggleAdv.textContent='Advanced filters';render();};

  qs('s-apply').onclick=()=>{sortKey=qs('s-key').value;closeModal(sortModal);render();};

  // Search functionality
  const searchInput = qs('searchInput');
  searchInput.addEventListener('input', () => {
    render();
  });

  document.addEventListener('visibilitychange',()=>{if(!document.hidden)render();});
}

function passes(c){
  // Search filter
  const searchTerm = qs('searchInput').value.toLowerCase().trim();
  if (searchTerm) {
    const searchableText = `${c.club_name} ${c.activity_type} ${c.location} ${c.description} ${c.tags}`.toLowerCase();
    if (!searchableText.includes(searchTerm)) return false;
  }

  // Basic filters
  if(qs('f-activity').value && c.activity_type!==qs('f-activity').value) return false;
  if(qs('f-location').value && c.location!==qs('f-location').value) return false;

  const pmin=parseFloat(qs('f-pmin').value)||0,pmax=qs('f-pmax').value?parseFloat(qs('f-pmax').value):Infinity;
  if(c.monthly_fee<pmin||c.monthly_fee>pmax) return false;

  if(qs('f-beginners').checked && !c.is_beginner_friendly) return false;
  if(qs('f-featured').checked && !c.featured) return false;

  // Advanced filters
  if(qs('f-ages').value && c.age_groups!==qs('f-ages').value) return false;
  if(qs('f-skills').value && c.skill_levels!==qs('f-skills').value) return false;

  const minRate=parseFloat(qs('f-stars').dataset.value)||0;if(c.rating<minRate) return false;
  const minMembers=parseFloat(qs('f-members').value)||0;if(c.total_members<minMembers) return false;

  if(qs('f-wheelchair').checked && !c.is_wheelchair_accessible) return false;
  if(qs('f-all-ages').checked && !c.is_all_ages) return false;

  return true;
}

const sortList = (list) => {
  const sortedList = [...list];
  
  switch(sortKey) {
    case 'priceLow':
      return sortedList.sort((a, b) => {
        if (a.monthly_fee !== b.monthly_fee) return a.monthly_fee - b.monthly_fee;
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'priceHigh':
      return sortedList.sort((a, b) => {
        if (b.monthly_fee !== a.monthly_fee) return b.monthly_fee - a.monthly_fee;
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'members':
      return sortedList.sort((a, b) => {
        if (b.total_members !== a.total_members) return b.total_members - a.total_members;
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'rating':
      return sortedList.sort((a, b) => {
        if (b.rating !== a.rating) return b.rating - a.rating;
        if (b.user_rating !== a.user_rating) return b.user_rating - a.user_rating;
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'name':
      return sortedList.sort((a, b) => {
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'location':
      return sortedList.sort((a, b) => {
        if (a.location !== b.location) return a.location.localeCompare(b.location);
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'default':
    default:
      return sortedList.sort((a, b) => {
        // Featured clubs first
        if (a.featured && !b.featured) return -1;
        if (!a.featured && b.featured) return 1;
        
        // Then by rating
        if (b.rating !== a.rating) return b.rating - a.rating;
        
        // Then by member count
        if (b.total_members !== a.total_members) return b.total_members - a.total_members;
        
        return a.club_name.localeCompare(b.club_name);
      });
  }
};

function renderStars(rating) {
  const maxStars = 5;
  let starsHTML = '';
  for (let i = 0; i < maxStars; i++) {
    const starPosition = i + 1;
    let starClass = 'star';
    let fillPercent = 0;
    if (rating >= starPosition) {
      starClass += ' filled';
    } else if (rating > i) {
      fillPercent = Math.round((rating - i) * 100);
      starClass += ' partial';
    }
    const fillStyle = fillPercent > 0 ? `style="--fill-percent: ${fillPercent}%"` : '';
    starsHTML += `<span class="${starClass}" ${fillStyle}>★</span>`;
  }
  return `<span class="club-rating-stars">${starsHTML}</span>`;
}

function getUserRatingColorClass(rating) {
  const roundedRating = Math.round(Math.max(0, Math.min(rating, 10)));
  return `club-score-${roundedRating}`;
}

function formatPrice(price) {
  if (price === 0) return '<span class="club-price free">FREE</span>';
  return `<span class="club-price">£${price}/month</span>`;
}

function render(){
  if(!isDataLoaded) return;
  const filteredList = clubs.filter(passes);
  const list = sortList(filteredList);
  qs('result-count').textContent=`Showing ${list.length} of ${clubs.length} clubs`;

  const cards=qs('cards');cards.innerHTML='';
  const frag=document.createDocumentFragment();
  
  for(const c of list){
    const el=document.createElement('div');
    el.className = c.featured ? 'club-card featured' : 'club-card';
    
    const websiteIcon = c.website ? 
      `<a href="${c.website}" target="_blank" rel="noopener noreferrer" class="club-website-icon" title="Visit website" onclick="event.stopPropagation()">🌐</a>` : 
      '';
    
    const ratingOverlay = c.user_rating ? 
      `<span class="club-rating-overlay ${getUserRatingColorClass(c.user_rating)}" title="Community rating">${c.user_rating.toFixed(1)}</span>` : 
      '';
    
    // Generate badges
    const badges = [];
    if (c.is_beginner_friendly) badges.push('<span class="club-badge beginners">Beginner Friendly</span>');
    if (c.is_wheelchair_accessible) badges.push('<span class="club-badge wheelchair">Wheelchair Access</span>');
    if (c.is_all_ages) badges.push('<span class="club-badge all-ages">All Ages</span>');
    if (c.skill_levels && c.skill_levels.toLowerCase().includes('advanced')) badges.push('<span class="club-badge advanced">Advanced</span>');
    
    // Club page URL
    const clubPageUrl = c.page_url || `/club/${c.club_code}`;
    
    el.innerHTML=`
      <div class="club-img-container">
        ${websiteIcon}
        ${ratingOverlay}
        <img class="club-img" loading="lazy" decoding="async"
             src="${c.image_url}" alt="${c.club_name}"
             onerror="this.src='https://source.unsplash.com/featured/?fitness'">
      </div>
      <div class="club-content">
        <h3 class="club-title">${c.club_name}</h3>
        <p class="club-activity">${c.activity_type}</p>
        <p class="club-location">📍 ${c.location}</p>

        <div class="club-stats-row">
          <div class="club-stat">
            <span class="club-stat-number">${c.total_members}</span>
            <span class="club-stat-label">Members</span>
          </div>
          <div class="club-stat">
            <span class="club-stat-number">${c.sessions_per_week}</span>
            <span class="club-stat-label">Sessions/Week</span>
          </div>
          <div class="club-stat">
            <span class="club-stat-number">${c.rating.toFixed(1)}</span>
            <span class="club-stat-label">NBRH Rating</span>
          </div>
        </div>

        <div class="club-price-rating-row">
          <div>
            ${formatPrice(c.monthly_fee)}
          </div>
          <div class="club-rating-section">
            <span title="NBRH rating">${c.rating.toFixed(1)}${renderStars(c.rating)}</span>
          </div>
        </div>

        <div class="club-badges-container">
          ${badges.join('')}
        </div>
      </div>
      <div class="club-card-actions">
        <a href="${clubPageUrl}" class="club-btn details">VIEW DETAILS</a>
        ${c.booking_url ? `<a href="${c.booking_url}" target="_blank" rel="noopener noreferrer" class="club-btn join">JOIN CLUB</a>` : `<a href="mailto:${c.email}" class="club-btn join">CONTACT</a>`}
      </div>`;
    frag.appendChild(el);
  }
  cards.appendChild(frag);
}

// Initialize when DOM loads
window.addEventListener('DOMContentLoaded',()=>setTimeout(()=>loadClubData(false),0));
</script>
</body>
</html>
