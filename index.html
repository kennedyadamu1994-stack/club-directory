<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discover Local Clubs</title>

<!-- Performance hints -->
<link rel="preconnect" href="https://sheets.googleapis.com">
<link rel="dns-prefetch" href="https://sheets.googleapis.com">

<style>
  :root{
    --brand:#FF006E;
    --bg:#ffffff;
    --text:#222;
    --muted:#666;
    --border:#e1e1e1;
    --radius:12px;
  }
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:#fafafa;
  }

  /* ---------- Loading / error ---------- */
  .club-loading,.club-error{max-width:1200px;margin:2rem auto;padding:0 1.5rem;text-align:center}
  .club-loading{color:var(--muted)}
  .club-spinner{display:inline-block;width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem}
  @keyframes spin{to{transform:rotate(360deg)}}
  .club-error{background:#fff5f5;border:1px solid #ffcccc;border-radius:var(--radius);color:#cc0000;padding:1.5rem}

  /* ---------- Header ---------- */
  .club-header{
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    padding: 60px 20px;
    margin-bottom: 30px;
  }
  
  .club-header h1{
    font-size: 42px;
    font-weight: 700;
    margin-bottom: 15px;
  }
  
  .club-header p{
    font-size: 20px;
    opacity: 0.9;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.4;
  }

  /* ---------- Toolbar ---------- */
  .club-toolbar{max-width:1400px;margin:0 auto;padding:1.5rem 1.5rem 0;display:flex;gap:0.75rem;flex-wrap:wrap}
  .club-btn{padding:0.5rem 1rem;border:1px solid var(--brand);border-radius:6px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;font-size:0.9rem;transition:all .2s ease}
  .club-btn:hover{background:#e60062;border-color:#e60062}
  .club-btn.secondary{background:#fff;color:var(--brand)}
  .club-btn.secondary:hover{background:#fff5f8}
  .club-btn:disabled{opacity:0.5;cursor:not-allowed}
  .club-btn.small{padding:0.35rem 0.75rem;font-size:0.85rem}

  /* ---------- Search Bar ---------- */
  .search-section{
    max-width: 1400px;
    margin: 0 auto 30px;
    padding: 0 1.5rem;
  }
  
  .search-container{
    position: relative;
    max-width: 600px;
    margin: 0 auto;
  }
  
  .search-input{
    width: 100%;
    padding: 16px 20px 16px 50px;
    border: 2px solid var(--border);
    border-radius: 25px;
    font-size: 16px;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }
  
  .search-input:focus{
    outline: none;
    border-color: var(--brand);
    box-shadow: 0 6px 20px rgba(255,0,110,0.2);
  }
  
  .search-icon{
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 18px;
  }

  /* ---------- Cards grid ---------- */
  .club-grid{
    max-width:1400px;
    margin:1rem auto 2rem;
    padding:0 1.5rem;
    display:grid;
    gap:2rem;
    grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
  }
  
  /* ---------- Card container ---------- */
  .club-card{
    display:flex;
    flex-direction:column;
    gap:1rem;
    transition:all .3s ease;
    background: white;
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  
  .club-card:hover{
    transform:translateY(-8px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
  }
  
  /* ---------- Image container ---------- */
  .club-img-container{
    position:relative;
    width:100%;
    height:200px;
    overflow:hidden;
  }
  
  /* ---------- Featured styling ---------- */
  .club-card.featured .club-img-container{
    border-bottom:4px solid #FFD700;
  }
  .club-card.featured .club-img-container::after{
    content:"FEATURED";
    position:absolute;
    top:12px;
    left:12px;
    background:#FFD700;
    color:#333;
    padding:6px 12px;
    border-radius:6px;
    font-size:0.75rem;
    font-weight:700;
    z-index:4;
    box-shadow:0 2px 8px rgba(0,0,0,0.3);
  }
  
  /* ---------- Image ---------- */
  .club-img{
    width:100%;
    height:100%;
    object-fit:cover;
    transition:transform .3s ease;
  }
  
  .club-card:hover .club-img{
    transform:scale(1.08);
  }
  
  /* ---------- Top overlay elements on image ---------- */
  .club-website-icon {
    position:absolute;
    top:12px;
    right:12px;
    width:36px;
    height:36px;
    background:rgba(255,255,255,0.9);
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    font-weight:600;
    color:var(--brand);
    text-decoration:none;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
    transition:all 0.2s ease;
    z-index:3;
    backdrop-filter:blur(10px);
  }
  .club-website-icon:hover { 
    background:rgba(255,255,255,1);
    transform:scale(1.1);
    color:var(--brand);
  }
  
  .club-rating-overlay {
    position:absolute;
    top:12px;
    left:12px;
    font-weight:700;
    padding:6px 10px;
    border-radius:3px;
    color:#fff;
    font-size:0.85rem;
    min-width:32px;
    text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,0.3);
    z-index:3;
    backdrop-filter:blur(10px);
  }
  .club-card.featured .club-rating-overlay { top:60px }
  
  /* Rating colors */
  .club-rating-overlay.club-score-0  { background:rgba(139,0,0,0.9) }
  .club-rating-overlay.club-score-1  { background:rgba(165,42,42,0.9) }
  .club-rating-overlay.club-score-2  { background:rgba(205,92,92,0.9) }
  .club-rating-overlay.club-score-3  { background:rgba(220,20,60,0.9) }
  .club-rating-overlay.club-score-4  { background:rgba(255,69,0,0.9) }
  .club-rating-overlay.club-score-5  { background:rgba(255,165,0,0.9) }
  .club-rating-overlay.club-score-6  { background:rgba(218,165,32,0.9) }
  .club-rating-overlay.club-score-7  { background:rgba(34,139,34,0.9) }
  .club-rating-overlay.club-score-8  { background:rgba(50,205,50,0.9) }
  .club-rating-overlay.club-score-9  { background:rgba(34,139,34,0.9) }
  .club-rating-overlay.club-score-10 { background:rgba(0,100,0,0.9) }
  
  /* ---------- Content below image ---------- */
  .club-content{
    display:flex;
    flex-direction:column;
    gap:0.75rem;
    padding: 20px;
  }
  
  .club-title{
    font-size:1.2rem;
    font-weight:700;
    color:var(--text);
    line-height:1.3;
    margin:0;
  }
  
  .club-activity{
    font-size:0.95rem;
    color:var(--brand);
    font-weight:600;
    margin:0;
  }
  
  .club-location{
    font-size:0.9rem;
    color:var(--muted);
    margin:0;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  
  /* ---------- Price and rating row ---------- */
  .club-price-rating-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:1rem;
    flex-wrap:wrap;
    margin-top: 10px;
  }
  
  .club-price{
    font-size:1.2rem;
    font-weight:700;
    color:var(--brand);
  }
  .club-price.free{color:#28a745}
  
  .club-rating-section{
    display:flex;
    align-items:center;
    gap:0.25rem;
    font-size:0.85rem;
    color:var(--muted);
  }
  
  /* ---------- Stats row ---------- */
  .club-stats-row{
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin: 15px 0;
  }
  
  .club-stat{
    text-align: center;
    padding: 12px 8px;
    background: #f8f9fa;
    border-radius: 6px;
  }
  
  .club-stat-number{
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--brand);
    display: block;
    margin-bottom: 2px;
  }
  
  .club-stat-label{
    font-size: 0.7rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ---------- Badges ---------- */
  .club-badges-container {
    display:flex;
    align-items:center;
    gap:6px;
    flex-wrap:wrap;
    margin-top: 10px;
  }
  
  .club-badge{
    display:inline-block;
    background:var(--brand);
    color:#fff;
    border-radius:4px;
    padding:3px 8px;
    font-size:0.7rem;
    font-weight:600;
  }
  
  .club-badge.beginners{background:#10B981}
  .club-badge.advanced{background:#8B5CF6}
  .club-badge.all-ages{background:#FF6B35}
  .club-badge.wheelchair{background:#3B82F6}
  
  /* ---------- Action buttons ---------- */
  .club-card-actions{
    display:flex;
    gap:0.75rem;
    margin-top:0.5rem;
    padding: 0 20px 20px;
  }
  .club-card-actions .club-btn{
    flex:1;
    padding:0.75rem 1rem;
    font-weight:600;
    font-size:0.9rem;
    text-align:center;
    border-radius:6px;
    transition:all .2s ease;
    border:1px solid var(--border);
    text-decoration: none;
    display: block;
  }
  .club-btn.details{
    background:#fff;
    color:var(--text);
    box-shadow:0 2px 4px rgba(0,0,0,0.05);
  }
  .club-btn.details:hover{
    background:#f8f9fa;
    box-shadow:0 4px 8px rgba(0,0,0,0.1);
  }
  .club-btn.join{
    background:var(--brand);
    border-color:var(--brand);
    color:#fff;
    box-shadow:0 2px 4px rgba(255,0,110,0.2);
  }
  .club-btn.join:hover{
    background:#e60062;
    border-color:#e60062;
    box-shadow:0 4px 8px rgba(255,0,110,0.3);
  }
  
  /* ---------- Stars ---------- */
  .club-rating-stars{display:inline-flex;gap:1px;margin-left:0.25rem}
  .club-rating-stars .star{color:#ddd;font-size:0.8rem}
  .club-rating-stars .star.filled{color:#fbbf24}
  .club-rating-stars .star.partial{
    background: linear-gradient(90deg, #fbbf24 var(--fill-percent, 0%), #ddd var(--fill-percent, 0%));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* ---------- Modal ---------- */
  .club-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:99999;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);padding:clamp(12px,3vw,24px)}
  .club-modal.active{display:flex}
  .club-dialog{background:#fff;border-radius:16px;width:100%;max-width:400px;padding:1.25rem;max-height:85vh;overflow-y:auto;box-shadow:0 20px 50px rgba(0,0,0,0.15);position:relative;margin-top:2rem}
  .club-dialog h2{margin:0 0 1.1rem;font-size:1.15rem}
  .club-field{margin-bottom:1rem;display:flex;flex-direction:column;font-size:0.9rem}
  .club-label{font-weight:600;margin-bottom:0.3rem;color:var(--text)}
  .club-dialog select,.club-dialog input[type="number"]{padding:0.5rem 0.7rem;border:1px solid var(--border);border-radius:6px;font-size:0.9rem;background:#fff}
  .club-dialog select:focus,.club-dialog input:focus{outline:none;border-color:var(--brand)}
  .club-check{display:flex;align-items:center;gap:0.5rem;font-size:0.9rem;margin-bottom:0.4rem}
  .club-actions{display:flex;gap:0.5rem;margin-top:1.2rem}
  .club-actions .club-btn{flex:1}

  /* ---------- Stars in filter ---------- */
  .club-stars{display:flex;gap:0.25rem;font-size:1.2rem;cursor:pointer}
  .club-stars span{color:var(--border);transition:color .2s}
  .club-stars span:hover{color:#ffb3d1}
  .club-stars span.active{color:var(--brand)}

  /* ---------- Advanced toggle ---------- */
  .club-advanced-toggle{width:100%;padding:0.65rem 1.2rem;margin:1rem 0;background:#f8f8f8;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:0.9rem;font-weight:600;color:var(--text);display:flex;align-items:center;justify-content:center;gap:0.5rem;transition:all .2s ease}
  .club-advanced-toggle:hover{background:#f0f0f0;border-color:#ccc}
  .club-advanced-toggle:after{content:'▼';font-size:0.7rem;transition:transform .3s ease}
  .club-advanced-toggle.active:after{transform:rotate(180deg)}
  .club-advanced-section{display:none;padding-top:0.5rem;border-top:1px solid var(--border);margin-top:1rem}
  .club-advanced-section.active{display:block}

  /* ---------- Mobile tweaks ---------- */
  @media (max-width:480px){
    .club-grid{grid-template-columns:1fr;padding:0 1rem;gap:1.5rem}
    .club-img-container{height:180px}
    .club-title{font-size:1.1rem}
    .club-activity{font-size:0.9rem}
    .club-location{font-size:0.85rem}
    .club-card-actions .club-btn{font-size:0.85rem;padding:0.65rem 0.8rem}
    .club-toolbar{flex-direction:column;gap:0.5rem}
    .club-header h1{font-size:32px}
    .club-header p{font-size:18px}
    .search-input{padding:14px 18px 14px 45px;font-size:14px}
  }
  @media (min-width:481px) and (max-width:768px){
    .club-grid{grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
  }
</style>
</head>

<body>
<!-- Header -->
<div class="club-header">
  <h1>Discover Local Clubs</h1>
  <p>Find the perfect community for your interests and activity level</p>
</div>

<!-- Search Section -->
<div class="search-section">
  <div class="search-container">
    <div class="search-icon">🔍</div>
    <input type="text" class="search-input" id="searchInput" placeholder="Search clubs by name, activity, or location...">
  </div>
</div>

<div id="loading-state" class="club-loading">
  <div class="club-spinner"></div><p>Loading clubs…</p>
</div>
<div id="error-state" class="club-error" style="display:none;">
  <p>Failed to load clubs. Check your connection or try again.</p>
  <button class="club-btn" onclick="loadClubData(true)">Try Again</button>
</div>

<div id="main-content" style="display:none;">
  <div class="club-toolbar">
    <button class="club-btn" id="open-filter">Filter Clubs</button>
    <button class="club-btn secondary" id="open-sort">Sort</button>
    <button class="club-btn secondary" onclick="window.tempCacheKey && localStorage.removeItem(window.tempCacheKey); loadClubData(true);" title="Clear cache and reload">Refresh Data</button>
    <p id="result-count" style="margin-left:auto;font-size:0.9rem;color:var(--muted)"></p>
  </div>
  <div id="cards" class="club-grid" aria-live="polite"></div>
</div>

<!-- ---------- Filter Modal ---------- -->
<div id="filter-modal" class="club-modal" aria-modal="true" role="dialog">
  <div class="club-dialog">
    <h2>Filter Clubs</h2>
    <div class="club-main-filters">
      <div class="club-field"><label class="club-label" for="f-activity">Activity Type</label><select id="f-activity"><option value="">Any activity</option></select></div>
      <div class="club-field"><label class="club-label" for="f-location">Location</label><select id="f-location"><option value="">Any location</option></select></div>
      <div class="club-field"><label class="club-label">Monthly fee £</label>
        <div style="display:flex;gap:0.5rem">
          <input type="number" id="f-pmin" placeholder="Min" min="0" value="0" style="width:100%">
          <input type="number" id="f-pmax" placeholder="Max" min="0" style="width:100%">
        </div>
      </div>
      <div class="club-check"><input type="checkbox" id="f-beginners"><label for="f-beginners">Beginner friendly</label></div>
      <div class="club-check"><input type="checkbox" id="f-featured"><label for="f-featured">Featured clubs only</label></div>
    </div>

    <button class="club-advanced-toggle" id="toggle-advanced">Advanced filters</button>

    <div class="club-advanced-section" id="advanced-section">
      <div class="club-field"><label class="club-label" for="f-ages">Age Groups</label>
        <select id="f-ages"><option value="">Any age group</option></select>
      </div>
      <div class="club-field"><label class="club-label" for="f-skills">Skill Levels</label>
        <select id="f-skills"><option value="">Any skill level</option></select>
      </div>
      <div class="club-field"><label class="club-label">NBRH Rating</label>
        <div id="f-stars" class="club-stars" data-value="0"></div>
        <small style="color:var(--muted);font-size:0.75rem">Minimum rating (0–5)</small>
      </div>
      <div class="club-field"><label class="club-label" for="f-members">Minimum members</label>
        <select id="f-members"><option value="">Any size</option><option value="50">50+ members</option><option value="100">100+ members</option><option value="200">200+ members</option></select>
      </div>
      <div class="club-check"><input type="checkbox" id="f-wheelchair"><label for="f-wheelchair">Wheelchair accessible</label></div>
      <div class="club-check"><input type="checkbox" id="f-all-ages"><label for="f-all-ages">All ages welcome</label></div>
    </div>

    <div class="club-actions">
      <button class="club-btn secondary" id="f-reset">Reset all</button>
      <button class="club-btn" id="f-apply">Apply filters</button>
    </div>
  </div>
</div>

<!-- ---------- Sort Modal ---------- -->
<div id="sort-modal" class="club-modal" aria-modal="true" role="dialog">
  <div class="club-dialog">
    <h2>Sort clubs by</h2>
    <div class="club-field">
      <select id="s-key">
        <option value="default">Default (Featured → Rating → Members)</option>
        <option value="rating">NBRH rating (high → low)</option>
        <option value="members">Member count (high → low)</option>
        <option value="priceLow">Price (low → high)</option>
        <option value="priceHigh">Price (high → low)</option>
        <option value="name">Name (A → Z)</option>
        <option value="location">Location (A → Z)</option>
      </select>
    </div>
    <div class="club-actions">
      <button class="club-btn secondary" id="s-close">Cancel</button>
      <button class="club-btn" id="s-apply">Apply</button>
    </div>
  </div>
</div>

<script>
/* ========= DYNAMIC CLUB DISCOVERY SYSTEM ========= */

/* ========= 1) CONFIG ========= */
// Use backend API instead of direct Google Sheets API
const API_BASE_URL = '/api'; // Your Vercel API endpoints
const CACHE_KEY = 'clubs:backend:v1';
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 min

/* ========= 2) GLOBALS ========= */
let clubs = [];
let filteredClubs = [];
let isDataLoaded = false;
let sortKey = 'default';
let _initDone = false;
let _fetchController = null;

window.tempCacheKey = CACHE_KEY;

/* ========= 3) DATA LOAD with backend API ========= */
async function fetchClubRows(forceFresh = false) {
  const now = Date.now();
  if (!forceFresh) {
    try {
      const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
      if (cached && now - cached.t < CACHE_TTL_MS) return cached.data;
    } catch {}
  }
  
  if (_fetchController) _fetchController.abort();
  _fetchController = new AbortController();
  
  // Use backend API to get all clubs
  const res = await fetch(`${API_BASE_URL}/clubs`, { 
    cache: 'no-store', 
    signal: _fetchController.signal 
  });
  
  if (!res.ok) {
    throw new Error(`Failed to load clubs: ${res.status} ${res.statusText}`);
  }
  
  const data = await res.json();
  
  try { 
    localStorage.setItem(CACHE_KEY, JSON.stringify({ t: now, data })); 
  } catch {}
  
  return data;
}

async function loadClubData(forceFresh = false) {
  const loadingState = document.getElementById('loading-state');
  const errorState   = document.getElementById('error-state');
  const mainContent  = document.getElementById('main-content');

  loadingState.style.display = 'block';
  errorState.style.display   = 'none';
  mainContent.style.display  = 'none';

  try {
    const clubsData = await fetchClubRows(forceFresh);
    console.log('Fetched club data:', clubsData);
    
    if (!clubsData || !Array.isArray(clubsData)) {
      throw new Error('Invalid data format received');
    }
    
    clubs = clubsData.map((club, i) => ({
      id: i + 1,
      club_id: String(club.club_id || ''),
      club_code: String(club.club_code || club.club_name?.toLowerCase().replace(/[^a-z0-9]+/g, '-')),
      club_name: String(club.club_name || 'Unnamed Club'),
      activity_type: String(club.activity_type || ''),
      location: String(club.location || ''),
      address: String(club.address || ''),
      monthly_fee: parseFloat(club.monthly_fee) || 0,
      description: String(club.description || ''),
      image_url: String(club.image_url || `https://source.unsplash.com/featured/?${club.activity_type||'fitness'}`),
      website: String(club.website || ''),
      phone: String(club.phone || ''),
      email: String(club.email || ''),
      rating: parseFloat(club.rating) || 0,
      user_rating: parseFloat(club.user_rating) || 0,
      review_count: parseFloat(club.review_count) || 0,
      total_members: parseFloat(club.total_members) || 0,
      sessions_per_week: parseFloat(club.sessions_per_week) || 0,
      age_groups: String(club.age_groups || ''),
      skill_levels: String(club.skill_levels || ''),
      tags: String(club.tags || ''),
      facilities: String(club.facilities || ''),
      instructor_name: String(club.instructor_name || ''),
      instructor_bio: String(club.instructor_bio || ''),
      active: String(club.active || '').toLowerCase() === 'yes',
      featured: club.featured === true || String(club.featured || '').toLowerCase() === 'yes',
      booking_url: String(club.booking_url || ''),
      page_url: String(club.page_url || `/club/${club.club_code || club.club_name?.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`),
      admin_url: String(club.admin_url || ''),
      
      // Computed properties
      is_beginner_friendly: String(club.tags || '').toLowerCase().includes('beginner'),
      is_wheelchair_accessible: String(club.facilities || '').toLowerCase().includes('wheelchair'),
      is_all_ages: String(club.age_groups || '').toLowerCase().includes('all ages')
    })).filter(club => club.active); // Only show active clubs

    if (!clubs.length) throw new Error('No active clubs found');

    loadingState.style.display = 'none';
    mainContent.style.display  = 'block';
    isDataLoaded = true;

    initializeApp();
  } catch (err) {
    if (err.name === 'AbortError') return;
    console.error('Error loading clubs:', err);
    loadingState.style.display = 'none';
    errorState.style.display   = 'block';
    
    // Update error message with more details
    const errorElement = errorState.querySelector('p');
    errorElement.textContent = `Failed to load clubs: ${err.message}. Please check your backend API configuration.`;
  }
}

/* ========= 4) INIT ========= */
function initializeApp() {
  if (_initDone) { render(); return; }
  _initDone = true;

  // Populate filter dropdowns
  const activities = [...new Set(clubs.map(c => c.activity_type))].filter(Boolean).sort();
  const actSelect  = document.getElementById('f-activity');
  actSelect.innerHTML = '<option value="">Any activity</option>';
  activities.forEach(a => { const o=document.createElement('option'); o.value=o.textContent=a; actSelect.appendChild(o); });

  const locations = [...new Set(clubs.map(c => c.location))].filter(Boolean).sort();
  const locSelect = document.getElementById('f-location');
  locSelect.innerHTML = '<option value="">Any location</option>';
  locations.forEach(l => { const o=document.createElement('option'); o.value=o.textContent=l; locSelect.appendChild(o); });

  const ageGroups = [...new Set(clubs.map(c => c.age_groups))].filter(Boolean).sort();
  const ageSelect = document.getElementById('f-ages');
  ageSelect.innerHTML = '<option value="">Any age group</option>';
  ageGroups.forEach(a => { const o=document.createElement('option'); o.value=o.textContent=a; ageSelect.appendChild(o); });

  const skillLevels = [...new Set(clubs.map(c => c.skill_levels))].filter(Boolean).sort();
  const skillSelect = document.getElementById('f-skills');
  skillSelect.innerHTML = '<option value="">Any skill level</option>';
  skillLevels.forEach(s => { const o=document.createElement('option'); o.value=o.textContent=s; skillSelect.appendChild(s); });

  buildStarUI();
  setupEventListeners();
  render();
}

const qs = id => document.getElementById(id);

function buildStarUI() {
  const wrap = qs('f-stars');
  wrap.innerHTML = '';
  for (let i=1;i<=5;i++){const s=document.createElement('span');s.textContent='★';s.dataset.val=i;wrap.appendChild(s);}
  updateStarUI(0);
  wrap.addEventListener('click',e=>{if(e.target.dataset.val){wrap.dataset.value=e.target.dataset.val;updateStarUI(e.target.dataset.val);}});
}
const updateStarUI = v => [...qs('f-stars').children].forEach((el,i)=>el.classList.toggle('active',i<v));

function setupEventListeners() {
  const openFilter=qs('open-filter'), openSort=qs('open-sort');
  const filterModal=qs('filter-modal'), sortModal=qs('sort-modal');
  const toggleAdv=qs('toggle-advanced'), advSection=qs('advanced-section');
  const closeModal=m=>{m.classList.remove('active');document.body.style.overflow='';};

  toggleAdv.onclick=()=>{toggleAdv.classList.toggle('active');advSection.classList.toggle('active');
    toggleAdv.textContent=toggleAdv.classList.contains('active')?'Hide advanced filters':'Advanced filters';};

  openFilter.onclick=()=>{filterModal.classList.add('active');document.body.style.overflow='hidden';};
  openSort  .onclick=()=>{sortModal .classList.add('active');document.body.style.overflow='hidden';};

  filterModal.addEventListener('click',e=>{if(e.target===filterModal)closeModal(filterModal);});
  sortModal  .addEventListener('click',e=>{if(e.target===sortModal )closeModal(sortModal );});
  qs('s-close').onclick=()=>closeModal(sortModal);

  qs('f-apply').onclick=()=>{closeModal(filterModal);render();};

  qs('f-reset').onclick=()=>{filterModal.querySelectorAll('select').forEach(s=>s.value='');
    filterModal.querySelectorAll('input[type="number"]').forEach(i=>i.value='');
    filterModal.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
    updateStarUI(0);qs('f-stars').dataset.value='0';toggleAdv.classList.remove('active');advSection.classList.remove('active');
    toggleAdv.textContent='Advanced filters';render();};

  qs('s-apply').onclick=()=>{sortKey=qs('s-key').value;closeModal(sortModal);render();};

  // Search functionality
  const searchInput = qs('searchInput');
  searchInput.addEventListener('input', () => {
    render();
  });

  document.addEventListener('visibilitychange',()=>{if(!document.hidden)render();});
}

function passes(c){
  // Search filter
  const searchTerm = qs('searchInput').value.toLowerCase().trim();
  if (searchTerm) {
    const searchableText = `${c.club_name} ${c.activity_type} ${c.location} ${c.description} ${c.tags}`.toLowerCase();
    if (!searchableText.includes(searchTerm)) return false;
  }

  // Basic filters
  if(qs('f-activity').value && c.activity_type!==qs('f-activity').value) return false;
  if(qs('f-location').value && c.location!==qs('f-location').value) return false;

  const pmin=parseFloat(qs('f-pmin').value)||0,pmax=qs('f-pmax').value?parseFloat(qs('f-pmax').value):Infinity;
  if(c.monthly_fee<pmin||c.monthly_fee>pmax) return false;

  if(qs('f-beginners').checked && !c.is_beginner_friendly) return false;
  if(qs('f-featured').checked && !c.featured) return false;

  // Advanced filters
  if(qs('f-ages').value && c.age_groups!==qs('f-ages').value) return false;
  if(qs('f-skills').value && c.skill_levels!==qs('f-skills').value) return false;

  const minRate=parseFloat(qs('f-stars').dataset.value)||0;if(c.rating<minRate) return false;
  const minMembers=parseFloat(qs('f-members').value)||0;if(c.total_members<minMembers) return false;

  if(qs('f-wheelchair').checked && !c.is_wheelchair_accessible) return false;
  if(qs('f-all-ages').checked && !c.is_all_ages) return false;

  return true;
}

const sortList = (list) => {
  const sortedList = [...list];
  
  switch(sortKey) {
    case 'priceLow':
      return sortedList.sort((a, b) => {
        if (a.monthly_fee !== b.monthly_fee) return a.monthly_fee - b.monthly_fee;
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'priceHigh':
      return sortedList.sort((a, b) => {
        if (b.monthly_fee !== a.monthly_fee) return b.monthly_fee - a.monthly_fee;
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'members':
      return sortedList.sort((a, b) => {
        if (b.total_members !== a.total_members) return b.total_members - a.total_members;
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'rating':
      return sortedList.sort((a, b) => {
        if (b.rating !== a.rating) return b.rating - a.rating;
        if (b.user_rating !== a.user_rating) return b.user_rating - a.user_rating;
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'name':
      return sortedList.sort((a, b) => {
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'location':
      return sortedList.sort((a, b) => {
        if (a.location !== b.location) return a.location.localeCompare(b.location);
        return a.club_name.localeCompare(b.club_name);
      });
      
    case 'default':
    default:
      return sortedList.sort((a, b) => {
        // Featured clubs first
        if (a.featured && !b.featured) return -1;
        if (!a.featured && b.featured) return 1;
        
        // Then by rating
        if (b.rating !== a.rating) return b.rating - a.rating;
        
        // Then by member count
        if (b.total_members !== a.total_members) return b.total_members - a.total_members;
        
        return a.club_name.localeCompare(b.club_name);
      });
  }
};

function renderStars(rating) {
  const maxStars = 5;
  let starsHTML = '';
  for (let i = 0; i < maxStars; i++) {
    const starPosition = i + 1;
    let starClass = 'star';
    let fillPercent = 0;
    if (rating >= starPosition) {
      starClass += ' filled';
    } else if (rating > i) {
      fillPercent = Math.round((rating - i) * 100);
      starClass += ' partial';
    }
    const fillStyle = fillPercent > 0 ? `style="--fill-percent: ${fillPercent}%"` : '';
    starsHTML += `<span class="${starClass}" ${fillStyle}>★</span>`;
  }
  return `<span class="club-rating-stars">${starsHTML}</span>`;
}

function getUserRatingColorClass(rating) {
  const roundedRating = Math.round(Math.max(0, Math.min(rating, 10)));
  return `club-score-${roundedRating}`;
}

function formatPrice(price) {
  if (price === 0) return '<span class="club-price free">FREE</span>';
  return `<span class="club-price">£${price}/month</span>`;
}

function render(){
  if(!isDataLoaded) return;
  const filteredList = clubs.filter(passes);
  const list = sortList(filteredList);
  qs('result-count').textContent=`Showing ${list.length} of ${clubs.length} clubs`;

  const cards=qs('cards');cards.innerHTML='';
  const frag=document.createDocumentFragment();
  
  for(const c of list){
    const el=document.createElement('div');
    el.className = c.featured ? 'club-card featured' : 'club-card';
    
    const websiteIcon = c.website ? 
      `<a href="${c.website}" target="_blank" rel="noopener noreferrer" class="club-website-icon" title="Visit website" onclick="event.stopPropagation()">🌐</a>` : 
      '';
    
    const ratingOverlay = c.user_rating ? 
      `<span class="club-rating-overlay ${getUserRatingColorClass(c.user_rating)}" title="Community rating">${c.user_rating.toFixed(1)}</span>` : 
      '';
    
    // Generate badges
    const badges = [];
    if (c.is_beginner_friendly) badges.push('<span class="club-badge beginners">Beginner Friendly</span>');
    if (c.is_wheelchair_accessible) badges.push('<span class="club-badge wheelchair">Wheelchair Access</span>');
    if (c.is_all_ages) badges.push('<span class="club-badge all-ages">All Ages</span>');
    if (c.skill_levels && c.skill_levels.toLowerCase().includes('advanced')) badges.push('<span class="club-badge advanced">Advanced</span>');
    
    // Club page URL
    const clubPageUrl = c.page_url || `/club/${c.club_code}`;
    
    el.innerHTML=`
      <div class="club-img-container">
        ${websiteIcon}
        ${ratingOverlay}
        <img class="club-img" loading="lazy" decoding="async"
             src="${c.image_url}" alt="${c.club_name}"
             onerror="this.src='https://source.unsplash.com/featured/?fitness'">
      </div>
      <div class="club-content">
        <h3 class="club-title">${c.club_name}</h3>
        <p class="club-activity">${c.activity_type}</p>
        <p class="club-location">📍 ${c.location}</p>

        <div class="club-stats-row">
          <div class="club-stat">
            <span class="club-stat-number">${c.total_members}</span>
            <span class="club-stat-label">Members</span>
          </div>
          <div class="club-stat">
            <span class="club-stat-number">${c.sessions_per_week}</span>
            <span class="club-stat-label">Sessions/Week</span>
          </div>
          <div class="club-stat">
            <span class="club-stat-number">${c.rating.toFixed(1)}</span>
            <span class="club-stat-label">NBRH Rating</span>
          </div>
        </div>

        <div class="club-price-rating-row">
          <div>
            ${formatPrice(c.monthly_fee)}
          </div>
          <div class="club-rating-section">
            <span title="NBRH rating">${c.rating.toFixed(1)}${renderStars(c.rating)}</span>
          </div>
        </div>

        <div class="club-badges-container">
          ${badges.join('')}
        </div>
      </div>
      <div class="club-card-actions">
        <a href="${clubPageUrl}" class="club-btn details">VIEW DETAILS</a>
        ${c.booking_url ? `<a href="${c.booking_url}" target="_blank" rel="noopener noreferrer" class="club-btn join">JOIN CLUB</a>` : `<a href="mailto:${c.email}" class="club-btn join">CONTACT</a>`}
      </div>`;
    frag.appendChild(el);
  }
  cards.appendChild(frag);
}

// Initialize when DOM loads
window.addEventListener('DOMContentLoaded',()=>setTimeout(()=>loadClubData(false),0));
</script>
</body>
</html>
